from __future__ import annotations

import contextlib
import logging
from datetime import datetime, timezone

from aiogram import F, Router
from aiogram.filters import StateFilter
from aiogra
@router.message(AdminMenu.users_menu, F.text == "ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ø±Øª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±")
async def admin_send_card_start(message: Message, state: FSMContext) -> None:
    services = get_services(message)
    users = await services.users.list_users()
    if not users:
        await message.answer("Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ø±Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.")
        return

    await state.set_state(AdminSendCard.choosing_user)
    await message.answer(
        "Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø´Ù†Ø§Ø³Ù‡ Ø§Ùˆ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ù†Ù…Ø§ÛŒÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø§Ø² Ø¯Ú©Ù…Ù‡ Â«ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒÂ» Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
        reply_markup=cancel_to_main_keyboard(),
    )

    lines = ["ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± Ø¯Ø³ØªØ±Ø³:"]
    for user in sorted(users, key=lambda item: item.full_name):
        entry = _format_user_entry(user)
        if not user.telegram_id:
            entry += " (Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…)"
        lines.append(entry)

    blocks: list[str] = []
    current_block = lines[0]
    for entry in lines[1:]:
        candidate = f"{current_block}\n{entry}"
        if len(candidate) > 3800:
            blocks.append(current_block)
            current_block = entry
        else:
            current_block = candidate
    if current_block:
        blocks.append(current_block)

    for block in blocks:
        await message.answer(block)

    await message.answer("Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…Ø¯Ù†Ø¸Ø± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ØªØ§ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§Ø¯Ø§Ù…Ù‡ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ø¯.")


@router.message(StateFilter(AdminSendCard.choosing_user))
async def admin_send_card_choose_user(message: Message, state: FSMContext) -> None:
    raw_text = (message.text or "").strip()
    if not raw_text.isdigit():
        await message.answer("Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯.")
        return

    user_id = int(raw_text)
    services = get_services(message)
    target_user = await services.users.get_by_id(user_id)
    if target_user is None:
        await message.answer("Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ø¯ÛŒÚ¯Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return
    if not target_user.telegram_id:
        await message.answer(
            "Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†ÙˆØ² Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ ÙØ¹Ø§Ù„ Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª Ùˆ Ø§Ù…Ú©Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ø±Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.")
        return

    await state.update_data(target_user_id=user_id, target_user_name=target_user.full_name)
    await state.set_state(AdminSendCard.choosing_card_type)
    await message.answer(
        f"Ú©Ø§Ø±Ø¨Ø± {target_user.full_name} Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ú©Ø§Ø±Øª Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.",
        reply_markup=card_type_keyboard(),
    )


@router.callback_query(StateFilter(AdminSendCard.choosing_card_type), F.data.startswith("card_type:"))
async def admin_send_card_type(callback: CallbackQuery, state: FSMContext) -> None:
    _, raw_type = callback.data.split(":", maxsplit=1)
    card_type = CardType(raw_type)
    await state.update_data(card_type=raw_type)
    await state.set_state(AdminSendCard.choosing_amount)
    await callback.message.edit_text(
        f"Ù†ÙˆØ¹ Ú©Ø§Ø±Øª {card_type_title(card_type)} Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯. Ù…Ø¨Ù„Øº Ú©Ø§Ø±Øª Ø±Ø§ ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯:",
        reply_markup=card_amount_keyboard(),
    )
    await callback.answer()


@router.callback_query(StateFilter(AdminSendCard.choosing_amount), F.data.startswith("card_amount:"))
async def admin_send_card_amount(callback: CallbackQuery, state: FSMContext) -> None:
    _, raw_amount = callback.data.split(":", maxsplit=1)
    if raw_amount == "custom":
        await callback.answer("Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ù…Ø¨Ù„Øº Ø¯Ù„Ø®ÙˆØ§Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.", show_alert=True)
        return

    amount = int(raw_amount)
    data = await state.get_data()
    target_user_id = data.get("target_user_id")
    card_type_raw = data.get("card_type")
    if target_user_id is None or card_type_raw is None:
        await state.clear()
        await state.set_state(AdminMenu.users_menu)
        await callback.message.edit_text("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù‚Øµ Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
        await callback.message.answer(
            "Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´ØªÛŒØ¯.",
            reply_markup=admin_users_menu_keyboard(),
        )
        await callback.answer()
        return

    services = get_services(callback)
    target_user = await services.users.get_by_id(target_user_id)
    if target_user is None:
        await state.clear()
        await state.set_state(AdminMenu.users_menu)
        await callback.message.edit_text("Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¯ÛŒÚ¯Ø± Ø¯Ø± Ø³ÛŒØ³ØªÙ… ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.")
        await callback.message.answer(
            "Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´ØªÛŒØ¯.",
            reply_markup=admin_users_menu_keyboard(),
        )
        await callback.answer()
        return
    if not target_user.telegram_id:
        await callback.message.edit_text(
            "Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø± Ø¨Ù‡ Ø±Ø¨Ø§Øª Ù…ØªØµÙ„ Ù†ÛŒØ³Øª. Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
        await state.clear()
        await state.set_state(AdminMenu.users_menu)
        await callback.message.answer(
            "Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´ØªÛŒØ¯.",
            reply_markup=admin_users_menu_keyboard(),
        )
        await callback.answer()
        return

    operator = await get_current_user(callback)
    actor_id = operator.id if operator else None
    card_type = CardType(card_type_raw)

    await callback.message.edit_text("â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ø±Øª...")
    try:
        card = await services.cards.take_first_available(
            card_type=card_type,
            amount=amount,
            actor_id=actor_id,
        )
    except NoResultFound:
        await callback.message.edit_text(
            f"âŒ Ù‡ÛŒÚ† Ú©Ø§Ø±Øª {card_type_title(card_type)} Ø¨Ø§ Ù…Ø¨Ù„Øº {amount:,} Ø¯ÛŒÙ†Ø§Ø± Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†ÛŒØ³Øª.")
        await callback.message.answer(
            "Ù…Ø¨Ù„Øº Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
            reply_markup=card_amount_keyboard(),
        )
        await callback.answer()
        return

    caption = (
        f"âœ… Ú©Ø§Ø±Øª {card_type_title(card.card_type)} Ø¨Ù‡ Ù…Ø¨Ù„Øº {card.amount:,} Ø¯ÛŒÙ†Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.\n"
        "Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡: Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ….")
    sent = await send_card_to_chat(
        callback.message.bot,
        services,
        card,
        target_user.telegram_id,
        caption,
    )
    if not sent:
        await services.cards.restore_card(card.id, actor_id=actor_id)
        await callback.message.edit_text(
            "Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ø±Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ú©Ù…ÛŒ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
        await callback.answer()
        return

    await services.cards.mark_sent(card.id, actor_id=actor_id)
    await notify_inventory_threshold(
        callback.message.bot,
        services,
        card.card_type,
        card.amount,
        exclude_user_id=actor_id,
    )

    if operator:
        logger.log_admin_action(
            action="send_card_direct",
            admin_id=operator.id,
            target_type="user",
            target_user_id=target_user.id,
            card_type=card.card_type.value,
            amount=card.amount,
            card_id=card.id,
        )

    admins = await services.users.list_admins()
    info_message = (
        f"Ø§Ø¯Ù…ÛŒÙ† {operator.full_name if operator else 'Ø³ÛŒØ³ØªÙ…'} Ú©Ø§Ø±Øª {card_type_title(card.card_type)}"
        f" Ø¨Ù‡ Ù…Ø¨Ù„Øº {card.amount:,} Ø¯ÛŒÙ†Ø§Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ {target_user.full_name} Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯.")
    for other_admin in admins:
        if not other_admin.telegram_id:
            continue
        if operator and other_admin.id == operator.id:
            continue
